<template lang="html">
  <v-card>
    <v-card-title class="headline">
      単一チェック・ディジット確認
    </v-card-title>
    <v-card-text>
      パスワード文字列が「ゲーム中で有効なものか」を確認できます。
    </v-card-text>
    <v-form ref="form">
      <v-container>
        <v-row>
          <v-col cols="12" sm="8" md="12">
            <v-text-field
              v-model="youkaiPassword"
              :counter="14"
              :rules="[validateYoukaiPassword]"
              @keypress="onKeyUp"
              label="妖怪的なパスワード"
              required
              maxlength="14"
              clearable
              class="input-yokai-password"
            ></v-text-field>
          </v-col>
        </v-row>
        <v-row>
          <v-col cols="12" sm="8" md="12">
            <v-text-field
              v-model="calculatedCheckDigit"
              value="a"
              label="算出されたチェック・ディジット"
              readonly
              outlined
            ></v-text-field>
          </v-col>
        </v-row>
        <v-row>
          <v-col>
            <v-textarea
              ref="progressLogsTextarea"
              v-model="resultInfomation"
              label="確認結果"
              readonly
              outlined
              no-resize
            ></v-textarea>        
          </v-col>
        </v-row>
      </v-container>
    </v-form>
    <v-card-text class="amber--text">
      「実機での動作を保証」するものではありません。<br>
      あくまで「チェッカー」です。どちらかに報告される際には、各自実機での動作確認をお願いします。
    </v-card-text>
  </v-card>
</template>

<script lang="ts">
import { Component, Inject, Vue, Watch } from 'vue-property-decorator'
import CodeToCharacterConverter from '@/domain/youkai/checkdigit/converter/CodeToCharacterConverter'
import CheckDigitCalculator from '@/domain/youkai/checkdigit/CheckDigitCalculator'
import AttackCharacters from '@/domain/youkai/checkdigit/state/AttackCharacters'
import A31F from '@/domain/youkai/checkdigit/state/A31F'

@Component
export default class SingleInputCheckDigitTry extends Vue {
  protected loading: boolean = false

  private youkaiPassword = 'KID'
  private calculatedCheckDigit = ' '
  private resultInfomation = ' '

  @Inject()
  private readonly converter?: CodeToCharacterConverter;

  @Inject()
  private readonly calculator?: CheckDigitCalculator;

  @Watch('youkaiPassword')
  private onChangeYoukaiPassword(): void {
    this.fixPasswordWhenInvalid();
    this.calculateAndHitCheckDigit();
  }

  private calculateAndHitCheckDigit(): void {
    this.calculateCheckDigit();
  }

  private calculateCheckDigit(): void {
    const validated = this.validateYoukaiPassword();
    console.log("validated: " + validated);
    if (this.validateYoukaiPassword() !== true) {
      this.calculatedCheckDigit = " ";
      return;  
    }
    const calculator = this.calculator as CheckDigitCalculator;
    const attackChars = AttackCharacters.withText(this.youkaiPassword);
    const checkDigit = calculator.calculate(attackChars);
    this.calculatedCheckDigit = checkDigit.toString();
  }

  private fixPasswordWhenInvalid():void  {
    const password = this.youkaiPassword;
    if (!this.converter?.isInvalidPassword(password)) return;
    this.youkaiPassword = this.converter?.fixValidPassword(password);
  }

  private validateYoukaiPassword(): boolean | string {
    const password = this.youkaiPassword;
    const min = 3;
    const max = 14;
    if (password.length < min || password.length > max) 
      return `${min}文字から${max}文字の範囲で入力して下さい。`;
    if (this.converter?.isInvalidPassword(password)) 
      return `XXX の文字の範囲で入力して下さい。`;
    return true;
  }

  private onKeyUp(event: KeyboardEvent): boolean {
    const keyName = event.code;
    if (keyName === 'Backspace' || keyName === 'Delete') return true;

    const valid = !this.converter?.isInvalidChar(event.key);
    if (valid) return true;
    const upperKey = event.key.toUpperCase();
    const nextValid = !this.converter?.isInvalidChar(upperKey);
    console.log(this.youkaiPassword);
    if (nextValid) return true;

    event.stopImmediatePropagation();
    event.preventDefault();
    return false;
  }
}
</script>

<style scoped>
.input-yokai-password {
  ime-mode: disabled;
}
</style>